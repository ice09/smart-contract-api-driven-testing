## EVM OpenAPI REST Interface Smart Contract Testing 

The initial version of this repository was generated by [Web3j-OpenAPI](https://docs.web3j.io/web3j_openapi) project using the [Epirus-CLI](https://docs.epirus.io/).

_Note: These steps show how to create a OpenAPI Web3j Gradle Project from scratch. This repository has all steps already completed for the `circles-ubi` contracts, so for testing you can skip to "Run OpenAPI"._

## Create Smart Contract OpenAPI/Swagger UI Generation for New Projects

* Create new OpenAPI Web3j Gradle project: `epirus openapi new`

### Project-Specific Modifications in Gradle Configuration

* Adjust Contract and Packages in `build.gradle`

```
web3j {
    generatedPackageName = 'io.circlesubi'
    addressBitLength = 160
    excludedContracts = ['SafeMath','Address']
    openapi {
    contextPath = 'circles-ubi'
    }
}

processResources {
    from('swagger-ui-openapi') { into 'static' }
}

startScripts {
    doLast {
        windowsScript.text = windowsScript.text.replaceAll('set CLASSPATH=.*', 'set CLASSPATH=.;%APP_HOME%/lib/*')
    }
}
```

* Set Project name in `settings.gradle`

`rootProject.name = 'circles-ubi';`

* Copy all smart contracts to `src/main/solidity`

## Run OpenAPI Smart Contracts REST Services with Swagger-UI

* Start _Ganache_, set mnemonic to **test test test test test test test test test test test junk**
   * Set default gas x10 in _Ganache_ (67219750)
* Run Application: Change to folder `start-scripts/run` and run `start-local-node-acct0.bat`
* Open Swagger-UI at http://localhost:9090/swagger-ui

### Using Different EOA accounts for Smart Contract Invocations

* We added 5 start scripts with the first 5 private keys for the given mnemonic above in the `start-scripts/run` folder.
* The contracts must be called at different ports for different accounts, `account 0: 9090`, `account 1: 9091`, ...

## Smart Contract Testing with the IntelliJ HTTP Plugin



#### Documentation: Manual Modifications for Circles UBI Contracts

1. Clone `git clone https://github.com/CirclesUBI/circles-contracts.git`
2. Copy `https://github.com/OpenZeppelin/openzeppelin-contracts/blob/solc-0.7/contracts/math/SafeMath.sol` to `deps/SafeMath.sol`
3. Copy `https://github.com/OpenZeppelin/openzeppelin-contracts/blob/solc-0.7/contracts/util/Address.sol` to `deps/Address.sol`
4. Change references in contracts to `SafeMath.sol` and `Address.sol` accordingly

#### Assemble Application

* Assemble Application: `gradlew generateWeb3jSwaggerUi distZip`
* Unzip `build/distribution/circles-ubi-*.zip`
* Copy `start-local-node.bat/sh` to unzipped `bin` directory `build/distribution/circles-ubi-*/bin`
* Run `start-local-node.bat/sh` in unzipped `bin` directory
