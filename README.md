## EVM OpenAPI REST Interface Smart Contract Testing 

The initial version of this repository was generated by [Web3j-OpenAPI](https://docs.web3j.io/web3j_openapi) project using the [Epirus-CLI](https://docs.epirus.io/).

_Note: These steps show how to create a OpenAPI Web3j Gradle Project from scratch. This repository has all steps already completed for the `circles-ubi` contracts, so for testing you can skip to "Run OpenAPI"._

## Create Smart Contract OpenAPI/Swagger UI Generation for New Projects

### Prerequisites

* Install [Epirus CLI](https://github.com/epirus-io/epirus-cli)

### Create new Project with Epirus

* Create new OpenAPI Web3j Gradle project: `epirus openapi new`

### Project-Specific Modifications in Gradle Configuration

* Adjust Contract and Packages in `build.gradle` according to your Smart Contracts

```
web3j {
    generatedPackageName = 'io.circlesubi'
    addressBitLength = 160
    excludedContracts = ['SafeMath','Address']
    openapi {
    contextPath = 'circles-ubi'
    }
}

processResources {
    from('swagger-ui-openapi') { into 'static' }
}

startScripts {
    doLast {
        windowsScript.text = windowsScript.text.replaceAll('set CLASSPATH=.*', 'set CLASSPATH=.;%APP_HOME%/lib/*')
    }
}
```

* Set Project name in `settings.gradle`

`rootProject.name = 'circles-ubi';`

* Copy all Smart Contracts to `src/main/solidity`

## Run OpenAPI Smart Contracts REST Services with Swagger-UI

_Note: You have to copy the current Smart Contracts from this repo: ... to the `src/main/solidity` folder_

* Start _Ganache_, set mnemonic to **test test test test test test test test test test test junk**
   * Set default gas x10 in _Ganache_ (67219750)
* Run Application: Change to folder `start-scripts/run` and run `start-local-node-acct0.bat`
* Open Swagger-UI at http://localhost:9090/swagger-ui

![](https://i.imgur.com/JMhIR9A.png)

### Using Different EOA accounts for Smart Contract Invocations

* We added 5 start scripts with the first 5 private keys for the given mnemonic above in the `start-scripts/run` folder.
* The contracts must be called at different ports for different accounts, `account 0: 9090`, `account 1: 9091`, ...
* For all existing tests in `src/test/http` tun run successfully, *node0, node1 and node2* must be running.

## Test Suite with IntelliJ REST Client

We are using the [IntelliJ HTTP Plugin (Ultimate Version)](https://www.jetbrains.com/help/idea/http-client-in-product-code-editor.html) for scripting REST Service tests.

_Note: You can as well use the Visual Studio Code REST Client for Testing, but without Assertions._

### Possible Actions on Responses

* Assert with `client.assert`
* Store responses with `client.global.set`
* Log variables with `client.log`

```javascript
###
### Deploy Hub Smart Constract
###

POST http://localhost:9090/circles-ubi/contracts/hub
Content-Type: application/json

{
  "_inflation": 1,
  "_period": 1,
  "_symbol": "CRC",
  "_name": "Circles",
  "_signupBonus": 50000000000000000000,
  "_initialIssuance": 1,
  "_timeout": 1
}

> {%
    client.test("Request executed successfully", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });
    client.global.set("hubContractAddress", response.body.contractAddress);
    client.log(client.global.get("hubContractAddress"));
%}
```

### Read Events to Verify Smart Contract Function Executions

* Call the function on the Smart Contract which emits the Event
* Store the complete response of the REST Service
* Use the stored response for Event retrieval

```javascript
###
### Signup with account 1
###

GET http://localhost:9091/circles-ubi/contracts/hub/{{hubContractAddress}}/signup

> {%
    client.test("Request executed successfully", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });
    client.global.set("signupResponse", JSON.stringify(response.body));
    client.log(client.global.get("signupResponse"));
%}

###
### Get Token Address from Token Contract Deployment Logs
###
POST http://localhost:9090/circles-ubi/contracts/hub/{{hubContractAddress}}/events/signup
Content-Type: application/json

{{signupResponse}}

> {%
    client.test("Request executed successfully", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });
    client.global.set("acct1TokenAddress", response.body[0].token);
    client.log(client.global.get("acct1TokenAddress"));
%}
```

## Test Suite with SoapUI

You can use any REST Service testing tool like Postman or SoapUI.

_Screenshot for SoapUI Sample Test Suite_

![](https://i.imgur.com/xKqaEQO.png)

### References

#### Documentation: Manual Modifications for Circles UBI Contracts

1. Clone `git clone https://github.com/CirclesUBI/circles-contracts.git`
2. Copy `https://github.com/OpenZeppelin/openzeppelin-contracts/blob/solc-0.7/contracts/math/SafeMath.sol` to `deps/SafeMath.sol`
3. Copy `https://github.com/OpenZeppelin/openzeppelin-contracts/blob/solc-0.7/contracts/util/Address.sol` to `deps/Address.sol`
4. Change references in contracts to `SafeMath.sol` and `Address.sol` accordingly

#### Assemble Application

* Assemble Application: `gradlew generateWeb3jSwaggerUi distZip`
* Unzip `build/distribution/circles-ubi-*.zip`
* Copy `start-local-node.bat/sh` to unzipped `bin` directory `build/distribution/circles-ubi-*/bin`
* Run `start-local-node.bat/sh` in unzipped `bin` directory
